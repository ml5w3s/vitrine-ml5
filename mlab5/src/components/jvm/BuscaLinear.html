<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Simulador Educacional - Busca Linear</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #f4f4f4; }
    textarea, pre { width: 100%; height: 200px; margin: 10px 0; font-size: 14px; }
    button { padding: 10px 20px; font-size: 16px; margin-right: 10px; }
    .section { background: white; padding: 15px; border: 1px solid #ccc; margin-bottom: 20px; border-radius: 8px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #999; padding: 8px; text-align: center; }
    .highlight { background: #ffff99; }
  </style>
</head>
<body>
  <h1>Simulador Educacional - Busca Linear em Array</h1>

  <div class="section">
    <h3>Bytecode (instruções simples)</h3>
    <textarea id="code" rows="20">
// Exemplo: Busca linear por 70 no array [10, 23, 45, 70, 11, 15]

// Carrega o array na memória (simulado com variáveis locais)
iconst_10
istore_3        // array[0] = 10
iconst_23
istore_4        // array[1] = 23
iconst_45
istore_5        // array[2] = 45
iconst_70
istore_6        // array[3] = 70
iconst_11
istore_7        // array[4] = 11
iconst_15
istore_8        // array[5] = 15

iconst_6        // tamanho do array
istore_1

iconst_0        // índice i = 0
istore_0

iconst_70       // valor alvo
istore_2

// Loop da busca linear
loop:
iload_0         // empilha i
iload_1         // empilha tamanho
if_icmpge end   // se i >= tamanho, vai para end

iload_0         // empilha i novamente
arrayload       // empilha array[i] (simulado com ifs abaixo)

iload_2         // empilha alvo
if_icmpeq found // se array[i] == alvo, encontrado!

iinc_0 1        // i++
goto loop

found:
iload_0
print           // imprime o índice encontrado
goto fim

end:
iconst_m1       // -1 = não encontrado
print

fim:
halt
</textarea>
  </div>

  <button id="run">Executar Tudo</button>
  <button id="step">Passo a Passo</button>
  <button id="reset">Resetar</button>

  <div class="section">
    <h3>Saída</h3>
    <pre id="output"></pre>
  </div>

  <div class="section">
    <h3>Estado da Máquina</h3>
    <table>
      <tr>
        <th>PC</th>
        <th>Pilha</th>
        <th>Vars Locais (0 a 8)</th>
      </tr>
      <tr>
        <td id="pc">0</td>
        <td id="stack">[]</td>
        <td id="locals">[0,0,0,0,0,0,0,0,0]</td>
      </tr>
    </table>
    <p>Instrução atual: <span id="currentInstr">-</span></p>
  </div>

  <script>
    const codeTextarea = document.getElementById('code');
    const output = document.getElementById('output');
    const pcEl = document.getElementById('pc');
    const stackEl = document.getElementById('stack');
    const localsEl = document.getElementById('locals');
    const currentInstrEl = document.getElementById('currentInstr');

    let program = [];
    let pc = 0;
    let stack = [];
    let locals = Array(9).fill(0); // variáveis locais 0 a 8
    let labels = {}; // para goto e if

    function parseCode() {
      const lines = codeTextarea.value.trim().split('\n');
      program = [];
      let lineNum = 0;

      lines.forEach(rawLine => {
        let line = rawLine.trim().split('//')[0].trim();
        if (!line) return;

        if (line.endsWith(':')) {
          labels[line.slice(0, -1)] = lineNum;
        } else {
          program.push(line);
          lineNum++;
        }
      });

      resetVM();
    }

    function resetVM() {
      pc = 0;
      stack = [];
      locals.fill(0);
      updateUI();
      output.textContent = '';
    }

    function updateUI() {
      pcEl.textContent = pc;
      stackEl.textContent = JSON.stringify(stack);
      localsEl.textContent = JSON.stringify(locals);
      currentInstrEl.textContent = pc < program.length ? program[pc] : 'FIM';
    }

    function executeInstruction() {
      if (pc >= program.length) return false;

      const instr = program[pc].toLowerCase();
      let parts = instr.split(' ');
      let op = parts[0];
      let arg = parts[1];

      switch (op) {
        case 'iconst_10': stack.push(10); break;
        case 'iconst_23': stack.push(23); break;
        case 'iconst_45': stack.push(45); break;
        case 'iconst_70': stack.push(70); break;
        case 'iconst_11': stack.push(11); break;
        case 'iconst_15': stack.push(15); break;
        case 'iconst_6': stack.push(6); break;
        case 'iconst_0': stack.push(0); break;
        case 'iconst_m1': stack.push(-1); break;

        case 'istore_0': case 'istore_1': case 'istore_2': case 'istore_3':
        case 'istore_4': case 'istore_5': case 'istore_6': case 'istore_7': case 'istore_8':
          locals[parseInt(op.slice(7))] = stack.pop();
          break;

        case 'iload_0': case 'iload_1': case 'iload_2':
          stack.push(locals[parseInt(op.slice(6))]);
          break;

        case 'iinc_0':
          locals[0] += parseInt(arg || 1);
          break;

        case 'arrayload': // simulação do array usando variáveis 3 a 8
          const index = stack.pop();
          stack.push(locals[3 + index]);
          break;

        case 'if_icmpeq':
          const b = stack.pop();
          const a = stack.pop();
          if (a === b) pc = labels[arg] - 1; // -1 porque pc++ será feito depois
          break;

        case 'if_icmpge':
          const bb = stack.pop();
          const aa = stack.pop();
          if (aa >= bb) pc = labels[arg] - 1;
          break;

        case 'goto':
          pc = labels[arg] - 1;
          break;

        case 'print':
          if (stack.length > 0) {
            output.textContent += 'Resultado: ' + stack.pop() + '\n';
          }
          break;

        case 'halt':
          output.textContent += "Execução terminada.\n";
          return false;

        default:
          output.textContent += `Instrução desconhecida: ${instr}\n`;
      }

      pc++;
      updateUI();
      return true;
    }

    document.getElementById('run').onclick = () => {
      parseCode();
      while (executeInstruction()) {}
    };

    document.getElementById('step').onclick = () => {
      if (pc === 0 && program.length === 0) parseCode();
      if (!executeInstruction()) {
        output.textContent += "Fim do programa.\n";
      }
    };

    document.getElementById('reset').onclick = () => resetVM();

    // Inicializa
    resetVM();
  </script>
</body>
</html>