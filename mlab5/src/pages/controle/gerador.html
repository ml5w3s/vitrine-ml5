<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerador de Página de Aula</title>
  <link href="/src/assets/css/base.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <style>
    body { padding: 20px; font-family: sans-serif; }
    h1 { margin-bottom: 20px; }
    input[type="file"] { display: block; margin-bottom: 20px; }
  </style>
</head>
<body>

  <h1>Gerador de Página de Aula</h1>
  <p>Selecione um arquivo <code>.json</code> de uma aula para gerar a página <code>index.html</code> final.</p>
  
  <input type="file" id="json-input" accept=".json">
  
  <div id="status"></div>

  <script>
    document.getElementById('json-input').addEventListener('change', handleFileSelect, false);

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) {
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let lessonData = JSON.parse(e.target.result);
          // Check if the data is wrapped in a "course" object
          if (lessonData.course) {
            lessonData = lessonData.course;
          }
          const finalHtml = generateHtml(lessonData);
          downloadHtml(finalHtml);
          document.getElementById('status').textContent = `Página 'index.html' gerada e baixada com sucesso!`;
        } catch (error) {
          console.error('Erro ao processar o arquivo JSON:', error);
          document.getElementById('status').textContent = `Erro: ${error.message}`;
        }
      };
      reader.readAsText(file);
    }

    function generateHtml(data) {
      const lessonContent = renderLessonContent(data);
      
      const htmlTemplate = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" type="image/x-icon" href="/src/assets/images/ml5w3s.ico">
  <title>${data.name || 'Aula'}</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="/src/assets/css/base.css" type="text/css" rel="stylesheet" media="screen,projection"/>
</head>
<body>
  <div id="header-placeholder"></div>
  <main id="aula" itemscope itemtype="https://schema.org/Course" class="container">
    ${lessonContent}
  </main>
  <div id="footer-placeholder"></div>

  <script src="/src/assets/js/main.js"><\/script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      loadComponent('header-placeholder', '/src/assets/js/ui/components/header.html');
      loadComponent('footer-placeholder', '/src/assets/js/ui/components/footer.html');
    });
  <\/script>
</body>
</html>`;
      return htmlTemplate;
    }

    function renderLessonContent(data) {
      let html = '';
      const articles = data.articles || data.artigos || []; // Handle both properties

      // Banner principal
      if (data.image && data.image.desktop) {
        html += `<section class="container">
        <article class="item">
          <picture itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
            <source media="(min-width:1024px)" srcset="${data.image.desktop}" itemprop="contentUrl">
            <source media="(min-width:600px)" srcset="${data.image.tablet}" itemprop="contentUrl">
            <img src="${data.image.mobile}" alt="${data.image.alt || ''}" itemprop="contentUrl">
          </picture>
          <h1 itemprop="name">${data.name}</h1>
        </article>
      </section>`;
      } else {
        // If no banner image, just render the title
        html += `<section class="container"><article class="item"><h1 itemprop="name">${data.name}</h1></article></section>`;
      };

      // Renderização dos artigos
      articles.forEach(article => {
        html += `<section class="container"><article class="item" itemscope itemtype="https://schema.org/Article" itemprop="hasPart">
        `;
        
        let content = `<meta itemprop="position" content="${article.position}">`;
        if (article.headline) content += `<h2 itemprop="headline">${article.headline}</h2>`;
        if (article.text) content += `<p itemprop="text">${article.text}</p>`;
        if (article.alternativeHeadline) content += `<h3 itemprop="alternativeHeadline">${article.alternativeHeadline}</h3>`;

        if (article.list) {
          content += '<ul class="left_list">';
          article.list.forEach(item => {
            content += `<li>${item}</li>`;
          });
          content += '</ul>';
        }

        if (article.code) {
          content += `<meta itemprop="programmingLanguage" content="${article.programmingLanguage || 'HTML'}">
                      <pre><code itemprop="text">${escapeHtml(Array.isArray(article.code) ? article.code.join('\n') : article.code)}</code></pre>`;
        }

        if (article.image) {
          content += `<figure itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
                        <img src="${article.image.src || article.image.mobile}" alt="${article.image.alt || ''}" itemprop="contentUrl">
                        ${article.image.caption ? `<figcaption itemprop="caption">${article.image.caption}</figcaption>` : ""}
                      </figure>`;
        }
        
        if (article.url) {
          content += `<a href="${article.url}" itemprop="url" class="btn-large">${article.label}</a>`;
        }

        html += content + '</article></section>';
      });

      // Render exercise
      if(data.exercise) {
        html += `<section class="container"><article class="item" id="exercicio">
`;
        let exerciseContent = `<h3>${data.exercise.headline}</h3><p>${data.exercise.text}</p><ul>`;
        data.exercise.steps.forEach(step => {
            exerciseContent += `<li>${step}</li>`;
        });
        exerciseContent += `</ul>`;
        html += exerciseContent + '</article></section>';
      }
      
      // Render playground link
      if(data.playground) {
          html += `<section class="container"><article class="item"><a href="${data.playground.url}" class="btn-large waves-effect waves-light teal lighten-1">${data.playground.label || 'Playground'}</a></article></section>`;
      }

      return html;
    }

    function escapeHtml(unsafe) {
      return unsafe
           .replace(/&/g, "&amp;")
           .replace(/</g, "&lt;")
           .replace(/>/g, "&gt;")
           .replace(/"/g, "&quot;")
           .replace(/'/g, "&#039;");
    }

    function downloadHtml(htmlContent) {
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'index.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }
  </script>
</body>
</html>
